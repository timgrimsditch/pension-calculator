<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pension Calculator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Replace Recharts with Chart.js which works better in vanilla HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-6">
                <h1 class="text-2xl font-bold mb-2">Pension Calculator</h1>
                <p class="text-sm text-gray-500 mb-6">All values are adjusted for inflation over time</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-2">Current Age</label>
                        <input type="number" id="currentAge" value="45" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Retirement Age</label>
                        <input type="number" id="retirementAge" value="65" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Current Pension Savings (£)</label>
                        <input type="number" id="currentPensionSavings" value="200000" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Annual Pension Contributions (£)</label>
                        <input type="number" id="annualPensionContributions" value="10000" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Current ISA Savings (£)</label>
                        <input type="number" id="currentIsaSavings" value="0" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Annual ISA Contributions (£)</label>
                        <input type="number" id="annualIsaContributions" value="0" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Desired Post-Tax Income (£)</label>
                        <input type="number" id="desiredPostTaxIncome" value="40000" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Expected Return Rate (%)</label>
                        <input type="number" id="returnRate" value="7" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-2">Expected Inflation Rate (%)</label>
                        <input type="number" id="inflationRate" value="2" 
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="takeLumpSum" checked 
                               class="rounded text-blue-600">
                        <label for="takeLumpSum">Take 25% tax-free lump sum at age 55</label>
                    </div>
                </div>
                
                <button id="calculateBtn" 
                        class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                    Calculate
                </button>

                <div id="results" class="mt-6 hidden">
                    <div class="mb-4 p-4 bg-gray-100 rounded" id="summary"></div>
                    <div class="h-64 mb-6">
                        <canvas id="pensionChart"></canvas>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2">Age</th>
                                    <th class="px-4 py-2">Total Savings</th>
                                    <th class="px-4 py-2">Investment Returns</th>
                                    <th class="px-4 py-2">Pension & ISA Contributions</th>
                                    <th class="px-4 py-2">Pension Withdrawals (Post-Tax)</th>
                                    <th class="px-4 py-2">Lump Sum</th>
                                    <th class="px-4 py-2">State Pension</th>
                                    <th class="px-4 py-2">Total Income</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null; // Store chart instance for updating

        function calculateTax(income) {
            let tax = 0;
            if (income > 125140) {
                tax += (income - 125140) * 0.45;
                income = 125140;
            }
            if (income > 50270) {
                tax += (income - 50270) * 0.4;
                income = 50270;
            }
            if (income > 12570) {
                tax += (income - 12570) * 0.2;
            }
            return tax;
        }

        function getInputs() {
            return {
                currentAge: parseInt(document.getElementById('currentAge').value),
                retirementAge: parseInt(document.getElementById('retirementAge').value),
                currentPensionSavings: parseInt(document.getElementById('currentPensionSavings').value),
                annualPensionContributions: parseInt(document.getElementById('annualPensionContributions').value),
                currentIsaSavings: parseInt(document.getElementById('currentIsaSavings').value),
                annualIsaContributions: parseInt(document.getElementById('annualIsaContributions').value),
                desiredPostTaxIncome: parseInt(document.getElementById('desiredPostTaxIncome').value),
                returnRate: parseFloat(document.getElementById('returnRate').value),
                inflationRate: parseFloat(document.getElementById('inflationRate').value),
                takeLumpSum: document.getElementById('takeLumpSum').checked
            };
        }

        function calculatePension(overrideInputs = null) {
            const inputs = overrideInputs || getInputs();
            let savingsTrajectory = [];
            let runOutAge = null;
            let pensionPot = inputs.currentPensionSavings;
            let isaPot = inputs.currentIsaSavings;
            let lumpSumTaken = false;
            
            for (let currentAge = inputs.currentAge; currentAge <= 100; currentAge++) {
                const yearsSinceStart = currentAge - inputs.currentAge;
                const inflationFactor = Math.pow(1 + inputs.inflationRate / 100, yearsSinceStart);
                
                const pensionReturns = pensionPot * (inputs.returnRate / 100);
                const isaReturns = isaPot * (inputs.returnRate / 100);
                const totalReturns = pensionReturns + isaReturns;
                
                let cashflow = 0;
                let lumpSumThisYear = 0;

                if (currentAge < inputs.retirementAge) {
                    const inflatedPensionContribution = inputs.annualPensionContributions * inflationFactor;
                    const inflatedIsaContribution = inputs.annualIsaContributions * inflationFactor;
                    
                    if (!lumpSumTaken && inputs.takeLumpSum && currentAge === Math.max(55, inputs.currentAge)) {
                        lumpSumThisYear = pensionPot * 0.25;
                        pensionPot -= lumpSumThisYear;
                        lumpSumTaken = true;
                    }
                    
                    pensionPot += inflatedPensionContribution + pensionReturns;
                    isaPot += inflatedIsaContribution + isaReturns;
                    cashflow = inflatedPensionContribution + inflatedIsaContribution;
                } else {
                    if (!lumpSumTaken && inputs.takeLumpSum) {
                        lumpSumThisYear = pensionPot * 0.25;
                        pensionPot -= lumpSumThisYear;
                        lumpSumTaken = true;
                    }

                    let yearlyWithdrawal = inputs.desiredPostTaxIncome * inflationFactor;
                    const statePension = currentAge >= 67 ? 11502 * inflationFactor : 0;
                    yearlyWithdrawal -= statePension;

                    const grossWithdrawal = yearlyWithdrawal + calculateTax(yearlyWithdrawal + statePension);
                    
                    pensionPot += pensionReturns - grossWithdrawal;
                    isaPot += isaReturns;
                    cashflow = -grossWithdrawal;
                }

                const statePension = currentAge >= 67 ? 11502 * inflationFactor : 0;
                
                savingsTrajectory.push({
                    age: currentAge,
                    totalSavings: Math.round(pensionPot + isaPot),
                    returns: Math.round(totalReturns),
                    contributions: currentAge < inputs.retirementAge ? 
                        Math.round(inputs.annualPensionContributions * inflationFactor + 
                                inputs.annualIsaContributions * inflationFactor) : 0,
                    withdrawals: currentAge >= inputs.retirementAge ? 
                        Math.round(Math.abs(cashflow)) : 0,
                    lumpSum: Math.round(lumpSumThisYear),
                    statePension: Math.round(statePension)
                });

                if ((pensionPot + isaPot) <= 0 && !runOutAge && currentAge >= inputs.retirementAge) {
                    runOutAge = currentAge;
                    pensionPot = 0;
                    isaPot = 0;
                }
            }

            return { savingsTrajectory, runOutAge };
        }

        function updateChart(data) {
            const ctx = document.getElementById('pensionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (chart) {
                chart.destroy();
            }
            
            // Create new chart
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.age),
                    datasets: [{
                        label: 'Total Savings',
                        data: data.map(d => d.totalSavings),
                        borderColor: '#2563eb',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '£' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '£' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateEarliestRetirementAge(results, inputs) {
            if (results.runOutAge) return null;
            
            // Binary search to find earliest retirement age
            let left = Math.max(55, inputs.currentAge); // Can't retire before 55
            let right = inputs.retirementAge;
            let earliestAge = inputs.retirementAge;
            
            while (left + 1 < right) {
                const mid = Math.floor((left + right) / 2);
                
                // Test this retirement age
                const testInputs = {...inputs, retirementAge: mid};
                const testResults = calculatePension(testInputs);
                
                if (testResults.runOutAge) {
                    left = mid;
                } else {
                    earliestAge = mid;
                    right = mid;
                }
            }
            
            return earliestAge < inputs.retirementAge ? earliestAge : null;
        }

        function calculateSustainableIncreaseInIncome(results, inputs) {
            if (results.runOutAge) return 0;
            
            // Get final savings at age 100
            const finalSavings = results.savingsTrajectory[results.savingsTrajectory.length - 1].totalSavings;
            
            // Binary search to find maximum sustainable increase
            let left = 0;
            let right = finalSavings / 5; // Wider initial range
            let maxIncrease = 0;
            const precision = 1; // £1 precision
            
            while (left + precision < right) {
                const mid = (left + right) / 2;
                
                // Test this income increase
                const testInputs = {...inputs, desiredPostTaxIncome: inputs.desiredPostTaxIncome + mid};
                const testResults = calculatePension(testInputs);
                
                const finalBalance = testResults.savingsTrajectory[testResults.savingsTrajectory.length - 1].totalSavings;
                
                if (testResults.runOutAge || finalBalance < 0) {
                    right = mid;
                } else if (finalBalance > precision) { // If we have more than £1 left, we can increase further
                    left = mid;
                    maxIncrease = mid;
                } else { // We've found a good balance (within £1 of zero)
                    maxIncrease = mid;
                    break;
                }
            }
            
            // Return the exact amount rounded to nearest pound
            return Math.floor(maxIncrease);
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            const tableBody = document.getElementById('resultsTable');
            
            resultsDiv.classList.remove('hidden');
            
            // Get current inputs
            const inputs = getInputs();
            
            // Create summary HTML
            let summaryHTML = '<div class="space-y-4">';
            
            if (results.runOutAge) {
                summaryHTML += `
                    <div class="text-red-600 font-semibold">
                        Your pension savings will run out by age ${results.runOutAge}.
                    </div>
                    <div>
                        Consider one or more of these options:
                        <ul class="list-disc ml-6 mt-2">
                            <li>Delay retirement (currently set to age ${inputs.retirementAge})</li>
                            <li>Increase your pension contributions (currently £${inputs.annualPensionContributions.toLocaleString()} per year)</li>
                            <li>Reduce your desired retirement income (currently £${inputs.desiredPostTaxIncome.toLocaleString()} per year)</li>
                        </ul>
                    </div>`;
            } else {
                const sustainableIncrease = calculateSustainableIncreaseInIncome(results, inputs);
                const newSuggestedIncome = inputs.desiredPostTaxIncome + sustainableIncrease;
                
                summaryHTML += `
                    <div class="text-green-600 font-semibold">
                        Your pension savings will not run out.
                    </div>`;
                
                // Calculate earliest retirement age
                const earliestRetirementAge = calculateEarliestRetirementAge(results, inputs);
                const yearsEarlier = earliestRetirementAge ? inputs.retirementAge - earliestRetirementAge : 0;
                
                if (sustainableIncrease > 0 || earliestRetirementAge) {
                    summaryHTML += `<div class="space-y-2">`;
                    
                    if (sustainableIncrease > 0) {
                        summaryHTML += `
                            <div>
                                Based on your projections, you could sustainably increase your annual post-tax retirement income by £${sustainableIncrease.toLocaleString()}.
                            </div>
                            <div>
                                Consider increasing your target retirement income from £${inputs.desiredPostTaxIncome.toLocaleString()} to £${newSuggestedIncome.toLocaleString()} per year.
                            </div>`;
                    }
                    
                    if (earliestRetirementAge) {
                        summaryHTML += `
                            <div class="mt-4">
                                Alternatively, you could maintain your target income of £${inputs.desiredPostTaxIncome.toLocaleString()} 
                                and retire ${yearsEarlier} year${yearsEarlier !== 1 ? 's' : ''} earlier at age ${earliestRetirementAge}.
                            </div>`;
                    }
                    
                    summaryHTML += `</div>`;
                }
            }
            
            summaryHTML += '</div>';
            summaryDiv.innerHTML = summaryHTML;

            // Update chart
            updateChart(results.savingsTrajectory);

            // Clear and populate table
            tableBody.innerHTML = '';
            results.savingsTrajectory.forEach(year => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2">${year.age}</td>
                    <td class="px-4 py-2">£${year.totalSavings.toLocaleString()}</td>
                    <td class="px-4 py-2">£${year.returns.toLocaleString()}</td>
                    <td class="px-4 py-2">${year.contributions > 0 ? `£${year.contributions.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2 text-red-600">${year.withdrawals > 0 ? `£${year.withdrawals.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2">${year.lumpSum > 0 ? `£${year.lumpSum.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2 text-green-600">${year.statePension > 0 ? `£${year.statePension.toLocaleString()}` : '-'}</td>
                    <td class="px-4 py-2 font-semibold">${(year.withdrawals > 0 || year.statePension > 0) ? 
                        `£${(year.withdrawals + year.statePension).toLocaleString()}` : '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        document.getElementById('calculateBtn').addEventListener('click', () => {
            const results = calculatePension();
            displayResults(results);
        });
    </script>
</body>
</html>